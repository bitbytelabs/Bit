name: Fix js/remote-property-injection

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  secure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install AST dependencies
        run: npm install @babel/parser @babel/traverse @babel/generator @babel/types

      - name: Create Fix Script
        run: |
          cat << 'EOF' > fix.js
          const fs = require("fs");
          const path = require("path");
          const parser = require("@babel/parser");
          const traverse = require("@babel/traverse").default;
          const generate = require("@babel/generator").default;
          const t = require("@babel/types");

          function isTargetFile(file) {
            return /\.(js|ts|jsx|tsx)$/.test(file);
          }

          function walk(dir) {
            let results = [];
            for (const file of fs.readdirSync(dir)) {
              const full = path.join(dir, file);

              if (full.includes("node_modules") || full.includes(".git")) continue;

              const stat = fs.statSync(full);

              if (stat.isDirectory()) {
                results = results.concat(walk(full));
              } else if (isTargetFile(full)) {
                results.push(full);
              }
            }
            return results;
          }

          function injectValidator(ast) {
            let exists = false;

            traverse(ast, {
              FunctionDeclaration(path) {
                if (path.node.id?.name === "isSafeKey") {
                  exists = true;
                }
              }
            });

            if (!exists) {
              const validator = parser.parse(`
                function isSafeKey(key) {
                  if (typeof key !== "string") return false;
                  const blocked = ["__proto__", "prototype", "constructor"];
                  if (blocked.includes(key)) return false;
                  return /^[a-zA-Z0-9_]+$/.test(key);
                }
              `);
              ast.program.body.unshift(...validator.program.body);
            }
          }

          function fixFile(file) {
            const code = fs.readFileSync(file, "utf8");
            const ast = parser.parse(code, {
              sourceType: "unambiguous",
              plugins: ["typescript", "jsx"]
            });

            let modified = false;

            traverse(ast, {
              AssignmentExpression(path) {
                if (path.node._secureWrapped) return;

                if (
                  t.isMemberExpression(path.node.left) &&
                  path.node.left.computed
                ) {
                  const obj = path.node.left.object;
                  const prop = path.node.left.property;
                  const value = path.node.right;

                  const safeAssign = t.assignmentExpression(
                    "=",
                    t.memberExpression(obj, prop, true),
                    value
                  );

                  safeAssign._secureWrapped = true;

                  const wrapped = t.ifStatement(
                    t.callExpression(t.identifier("isSafeKey"), [prop]),
                    t.blockStatement([
                      t.expressionStatement(safeAssign)
                    ])
                  );

                  path.replaceWith(wrapped);
                  path.skip();
                  modified = true;
                }
              }
            });

            if (modified) {
              injectValidator(ast);
              const output = generate(ast, {}, code);
              fs.writeFileSync(file, output.code);
              console.log("Fixed:", file);
            }
          }

          walk(process.cwd()).forEach(fixFile);
          EOF

      - name: Run Fixer
        run: node fix.js

      - name: Commit & Push If Changes
        run: |
          git config user.name "security-bot"
          git config user.email "security-bot@users.noreply.github.com"

          if [[ -n $(git status --porcelain) ]]; then
            git checkout -b security/remote-property-fix
            git add .
            git commit -m "Fix js/remote-property-injection"
            git push origin security/remote-property-fix
          else
            echo "No changes needed"
          fi

      - name: Create PR
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          branch: security/remote-property-fix
          title: "Fix js/remote-property-injection"
          body: |
            Automatically mitigates CodeQL rule js/remote-property-injection
            by wrapping dynamic property assignments in a safe validator.
